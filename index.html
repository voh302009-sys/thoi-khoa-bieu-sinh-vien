<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Hệ Thống TKB - Khôi Phục Dữ Liệu & Cảnh Báo</title>
    <style>
        :root { --red: #ff0000; --blue: #0000ff; --warning: #ffd700; --bg-conflict: #ffcccc; }
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; background-color: #f4f7f6; text-align: center; }
        
        /* Giao diện Đăng nhập */
        #login-screen { display: flex; justify-content: center; align-items: center; height: 100vh; background: #2c3e50; position: fixed; width: 100%; top: 0; left: 0; z-index: 1000; }
        .auth-box { background: white; padding: 30px; border-radius: 12px; width: 350px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        /* Giao diện Chính */
        #main-app { display: none; padding: 20px; }
        input, select { padding: 10px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; }
        .admin-panel { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        /* Bảng TKB */
        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { border: 1px solid #aaa; padding: 10px; vertical-align: top; }
        th { background: #34495e; color: white; }
        .col-phong { background: #ecf0f1; font-weight: bold; width: 120px; vertical-align: middle; font-size: 16px; }

        /* Hiển thị Môn học */
        .mon-item { border-bottom: 1px solid #eee; padding: 10px 0; display: flex; flex-direction: column; align-items: center; }
        .ten-mon { font-weight: bold; color: var(--red); text-transform: uppercase; font-size: 14px; }
        .gv-name { font-style: italic; color: var(--blue); margin: 3px 0; }
        .info-phu { font-size: 12px; color: #555; }
        
        /* Cảnh báo */
        .khac-co-so { background: var(--warning); color: #856404; font-weight: bold; font-size: 11px; padding: 5px; border-radius: 4px; margin-bottom: 5px; display: block; border: 1px solid #e6c200; }
        .trung-lich { background: white; color: var(--red); font-weight: bold; text-transform: uppercase; border: 1px solid var(--red); padding: 2px 5px; font-size: 11px; margin-top: 5px; }
        .bg-conflict { background-color: var(--bg-conflict) !important; }

        button { cursor: pointer; border: none; border-radius: 4px; font-weight: bold; }
        .btn-add { background: #27ae60; color: white; padding: 15px; grid-column: 1/-1; }
        .btn-export { background: #e67e22; color: white; padding: 10px; margin-top: 10px; }
        .btn-del { background: #e74c3c; color: white; padding: 5px 10px; font-size: 11px; margin-top: 5px; }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="auth-box">
        <h2>ĐĂNG NHẬP</h2>
        <input type="text" id="u-id" placeholder="Tài khoản (giangvien/sv...)">
        <input type="password" id="u-pw" placeholder="Mật khẩu">
        <button onclick="doLogin()" style="width:100%; background:#27ae60; color:white; padding:12px; margin-top:10px;">VÀO HỆ THỐNG</button>
    </div>
</div>

<div id="main-app">
    <div style="margin-bottom: 20px;">
        <input type="date" id="week-picker" onchange="render()">
        <button onclick="location.reload()">Đăng xuất</button>
    </div>

    <div id="gv-form" class="admin-panel" style="display: none;">
        <input type="text" id="f-n" placeholder="Tên môn học">
        <select id="f-t"><option>LÍ THUYẾT</option><option>THỰC HÀNH</option></select>
        <input type="number" id="f-tc" placeholder="Số tín chỉ">
        <input type="text" id="f-c" placeholder="Mã HP">
        <input type="text" id="f-gv" placeholder="Giảng viên">
        <select id="f-cs"><option>ADV</option><option>LVS</option><option>LLQ</option></select>
        <input type="text" id="f-r" placeholder="Phòng">
        <select id="f-d"><option value="2">Thứ 2</option><option value="3">Thứ 3</option><option value="4">Thứ 4</option><option value="5">Thứ 5</option><option value="6">Thứ 6</option><option value="7">Thứ 7</option><option value="8">CN</option></select>
        <input type="time" id="f-t1" value="06:30">
        <input type="time" id="f-t2" value="09:00">
        <input type="date" id="f-d1">
        <input type="date" id="f-d2">
        <button class="btn-add" onclick="addM()">THÊM MÔN HỌC</button>
        <button class="btn-export" onclick="exportJSON()">XUẤT DỮ LIỆU JSON (GỬI AI)</button>
    </div>

    <table>
        <thead>
            <tr><th>Cơ sở - Phòng</th><th>Thứ 2</th><th>Thứ 3</th><th>Thứ 4</th><th>Thứ 5</th><th>Thứ 6</th><th>Thứ 7</th><th>CN</th></tr>
        </thead>
        <tbody id="tkb-body"></tbody>
    </table>
</div>

<script>
    // --- KHÔI PHỤC DỮ LIỆU BỊ MẤT ---
    function getSafeData() {
        const keys = ['final_tkb_data', 'tkb_courses_db', 'tkb_data'];
        let raw = [];
        for (let k of keys) {
            let d = localStorage.getItem(k);
            if (d) { raw = JSON.parse(d); break; }
        }
        
        return raw.map(i => ({
            id: i.id || Date.now() + Math.random(),
            n: (i.n || i.name || "N/A").toUpperCase(),
            tp: i.tp || i.type || "Lí thuyết",
            tc: i.tc || i.credits || "0", // Khôi phục Tín chỉ
            cd: i.cd || i.code || "N/A",    // Khôi phục Mã HP
            gv: i.gv || "Chưa rõ",
            cs: (i.cs || i.campus || "ADV").toUpperCase(),
            r: (i.r || i.room || "Chưa rõ").toUpperCase(),
            dy: i.dy || i.day || 2,
            t1: i.t1 || "00:00", t2: i.t2 || "00:00",
            d1: i.d1 || i.startDate || "", // Khôi phục Ngày bắt đầu
            d2: i.d2 || i.endDate || ""    // Khôi phục Ngày kết thúc
        }));
    }

    let listM = getSafeData();
    let curU = "";
    document.getElementById('week-picker').valueAsDate = new Date();

    function doLogin() {
        const u = document.getElementById('u-id').value.toLowerCase();
        const p = document.getElementById('u-pw').value;
        if ((u === 'giangvien' && p === 'gv123') || (u.startsWith('sv') && p === 'sv123')) {
            curU = u;
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            if(u === 'giangvien') document.getElementById('gv-form').style.display = 'grid';
            render();
        } else alert("Sai tài khoản!");
    }

    function addM() {
        const m = {
            id: Date.now(), n: document.getElementById('f-n').value.toUpperCase(),
            tp: document.getElementById('f-t').value, tc: document.getElementById('f-tc').value,
            cd: document.getElementById('f-c').value, gv: document.getElementById('f-gv').value,
            cs: document.getElementById('f-cs').value, r: document.getElementById('f-r').value.toUpperCase(),
            dy: document.getElementById('f-d').value, t1: document.getElementById('f-t1').value,
            t2: document.getElementById('f-t2').value, d1: document.getElementById('f-d1').value,
            d2: document.getElementById('f-d2').value
        };
        listM.push(m);
        localStorage.setItem('final_tkb_data', JSON.stringify(listM));
        render();
    }

    function render() {
        const tbody = document.getElementById('tkb-body');
        tbody.innerHTML = "";
        
        const selDate = new Date(document.getElementById('week-picker').value);
        const day = selDate.getDay();
        const mon = new Date(selDate.setDate(selDate.getDate() - (day === 0 ? 6 : day - 1))); mon.setHours(0,0,0,0);
        const sun = new Date(mon); sun.setDate(mon.getDate() + 6); sun.setHours(23,59,59,999);

        let weekM = listM.filter(m => {
            let s = new Date(m.d1); let e = new Date(m.d2);
            return s <= sun && e >= mon;
        });

        let rooms = [...new Set(weekM.map(x => `${x.cs}|${x.r}`))].sort();

        rooms.forEach(rk => {
            const [cs, rm] = rk.split('|');
            const row = document.createElement('tr');
            row.innerHTML = `<td class="col-phong">${cs}<br>${rm}</td>`;
            
            for(let d=2; d<=8; d++) {
                let cellM = weekM.filter(x => x.dy == d && x.cs == cs && x.r == rm).sort((a,b)=>a.t1.localeCompare(b.t1));
                let dayAll = weekM.filter(x => x.dy == d); // Toàn bộ môn trong ngày để check trùng
                
                let html = ""; let hasConflict = false;

                // Cảnh báo Khác cơ sở
                if(new Set(dayAll.map(x => x.cs)).size > 1 && cellM.length > 0) {
                    html += `<span class="khac-co-so">⚠ Khác cơ sở trong buổi học</span>`;
                }

                cellM.forEach(m => {
                    // Check Trùng Lịch (Giao thoa thời gian)
                    let isConflict = dayAll.some(o => m.id !== o.id && m.t1 < o.t2 && o.t1 < m.t2);
                    if(isConflict) hasConflict = true;

                    html += `<div class="mon-item">
                        <span class="ten-mon">${m.n} (${m.tp})</span>
                        <span class="info-phu">${m.cd} - ${m.tc} TC</span>
                        <span style="font-weight:bold; font-size:15px; margin:2px 0;">${m.t1} - ${m.t2}</span>
                        <span class="gv-name">${m.gv}</span>
                        <span class="info-phu">${m.cs}, ${m.r}</span>
                        <span class="info-phu">${m.d1.split('-').reverse().join('/')} - ${m.d2.split('-').reverse().join('/')}</span>
                        ${isConflict ? '<span class="trung-lich">Trùng lịch</span>' : ''}
                        ${curU === 'giangvien' ? `<button class="btn-del" onclick="del(${m.id})">Xóa</button>` : ''}
                    </div>`;
                });
                
                let td = document.createElement('td');
                if(hasConflict) td.className = 'bg-conflict';
                td.innerHTML = html;
                row.appendChild(td);
            }
            tbody.appendChild(row);
        });
    }

    function del(id) {
        if(confirm("Xóa môn học này?")) {
            listM = listM.filter(x => x.id !== id);
            localStorage.setItem('final_tkb_data', JSON.stringify(listM));
            render();
        }
    }

    function exportJSON() {
        const dataStr = JSON.stringify(listM);
        const blob = new Blob([dataStr], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = "tkb_data.json"; a.click();
        alert("Đã tải file dữ liệu! Bạn có thể mở file này bằng Notepad để copy dữ liệu gửi sinh viên.");
    }
</script>
</body>
</html>
