<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Thời Khóa Biểu Sinh Viên - Bản Đã Nhập Liệu</title>
    <style>
        :root { --red: #ff0000; --blue: #0000ff; --warning: #ffd700; --bg-conflict: #ffcccc; }
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; background-color: #f4f7f6; text-align: center; }
        
        #login-screen {
            display: flex; justify-content: center; align-items: center; height: 100vh;
            background: #2c3e50; position: fixed; width: 100%; top: 0; left: 0; z-index: 1000;
        }
        .auth-box { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); width: 90%; max-width: 400px; }
        input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; text-align: center; }
        button { padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; margin: 5px; }
        .btn-green { background: #27ae60; color: white; width: 100%; }

        #main-app { display: none; padding: 10px; }
        .admin-panel { background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 2px solid #e74c3c; }
        
        .week-filter { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; display: inline-block; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .table-container { overflow-x: auto; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; background: white; min-width: 900px; }
        th, td { border: 1px solid #aaa; padding: 8px; text-align: center; vertical-align: top; }
        th { background: #34495e; color: white; font-size: 13px; }
        .col-phong { background: #ecf0f1; font-weight: bold; width: 110px; vertical-align: middle; }

        .mon-item { border-bottom: 2px dashed #eee; padding: 8px 0; display: flex; flex-direction: column; align-items: center; }
        .ten-mon { font-weight: bold; text-transform: uppercase; color: var(--red); font-size: 13px; margin-bottom: 3px; }
        .gv-name { font-style: italic; color: var(--blue); font-size: 12px; }
        .trung-lich { color: var(--red); font-weight: bold; font-size: 12px; display: block; margin-top: 5px; text-transform: uppercase; background: white; padding: 2px; }
        .bg-conflict { background-color: var(--bg-conflict) !important; }
        .btn-del { background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 10px; margin-top: 5px; }

        @media print { .admin-panel, .week-filter, button, #login-screen { display: none !important; } #main-app { display: block !important; } }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="auth-box">
        <h2>HỆ THỐNG TKB</h2>
        <input type="text" id="u-id" placeholder="Tên đăng nhập (sv...)">
        <input type="password" id="u-pw" placeholder="Mật khẩu">
        <button class="btn-green" onclick="doLogin()">XEM THỜI KHÓA BIỂU</button>
        <p style="font-size: 12px; color: #7f8c8d; margin-top: 15px;">Dữ liệu đã được giảng viên cập nhật sẵn.</p>
    </div>
</div>

<div id="main-app">
    <div style="margin-bottom: 15px;">
        Chào bạn: <strong id="user-tag"></strong> | 
        <button onclick="location.reload()" style="background:#95a5a6; color:white;">Đăng xuất</button>
    </div>

    <div class="week-filter">
        <strong>Chọn tuần xem: </strong>
        <input type="date" id="week-picker" onchange="render()">
    </div>

    <div id="gv-form" class="admin-panel" style="display: none;">
        <h3 style="grid-column: 1/-1; margin: 0; color: #e74c3c;">CHẾ ĐỘ CHỈNH SỬA</h3>
        <input type="text" id="f-n" placeholder="Tên môn">
        <input type="text" id="f-gv" placeholder="Giảng viên">
        <input type="text" id="f-r" placeholder="Phòng">
        <select id="f-cs"><option>ADV</option><option>LVS</option><option>LLQ</option></select>
        <select id="f-d"><option value="2">Thứ 2</option><option value="3">Thứ 3</option><option value="4">Thứ 4</option><option value="5">Thứ 5</option><option value="6">Thứ 6</option><option value="7">Thứ 7</option><option value="8">CN</option></select>
        <input type="time" id="f-t1" value="12:30"> <input type="time" id="f-t2" value="15:00">
        <input type="date" id="f-d1"> <input type="date" id="f-d2">
        <button class="btn-green" style="grid-column: 1/-1" onclick="addM()">CẬP NHẬT LỊCH CHUNG</button>
        <button onclick="exportData()" style="background:#f39c12; color:white; grid-column: 1/-1">XUẤT FILE SAO LƯU (JSON)</button>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr><th>Phòng</th><th>Thứ 2</th><th>Thứ 3</th><th>Thứ 4</th><th>Thứ 5</th><th>Thứ 6</th><th>Thứ 7</th><th>CN</th></tr>
            </thead>
            <tbody id="tkb-body"></tbody>
        </table>
    </div>
</div>

<script>
    // ==========================================
    // BƯỚC QUAN TRỌNG: DÁN DỮ LIỆU JSON VÀO NGOẶC [] DƯỚI ĐÂY
    // ==========================================
    const DATA_GOC = []; 

    // Kiểm tra nếu máy người dùng đã có dữ liệu thì lấy, nếu không thì lấy DATA_GOC
    let listM = (localStorage.getItem('final_tkb_data')) ? JSON.parse(localStorage.getItem('final_tkb_data')) : DATA_GOC;
    
    // Nếu bạn muốn ép sinh viên phải dùng dữ liệu mới nhất bạn vừa dán, hãy bỏ comment dòng dưới:
    // listM = DATA_GOC; 

    let curU = "";
    document.getElementById('week-picker').valueAsDate = new Date();

    function doLogin() {
        const u = document.getElementById('u-id').value.trim().toLowerCase();
        const p = document.getElementById('u-pw').value;
        if ((u === 'giangvien' && p === 'gv123') || (u.startsWith('sv') && p === 'sv123') || u === 'sinhvien') {
            curU = u;
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            document.getElementById('user-tag').innerText = u;
            if(u === 'giangvien') document.getElementById('gv-form').style.display = 'grid';
            render();
        } else alert("Sai thông tin!");
    }

    function addM() {
        const m = {
            id: Date.now(), n: document.getElementById('f-n').value.toUpperCase(),
            gv: document.getElementById('f-gv').value, cs: document.getElementById('f-cs').value,
            r: document.getElementById('f-r').value.toUpperCase(), dy: document.getElementById('f-d').value,
            t1: document.getElementById('f-t1').value, t2: document.getElementById('f-t2').value,
            d1: document.getElementById('f-d1').value, d2: document.getElementById('f-d2').value,
            tp: "Lí thuyết", tc: "4", cd: "N/A"
        };
        listM.push(m);
        localStorage.setItem('final_tkb_data', JSON.stringify(listM));
        render();
    }

    function render() {
        const tbody = document.getElementById('tkb-body');
        tbody.innerHTML = "";
        const selDate = new Date(document.getElementById('week-picker').value);
        const day = selDate.getDay();
        const mon = new Date(selDate.setDate(selDate.getDate() - (day === 0 ? 6 : day - 1))); mon.setHours(0,0,0,0);
        const sun = new Date(mon); sun.setDate(mon.getDate() + 6); sun.setHours(23,59,59,999);

        let weekM = listM.filter(m => {
            let s = new Date(m.d1); let e = new Date(m.d2);
            return s <= sun && e >= mon;
        });

        let rooms = [...new Set(weekM.map(x => `${x.cs}|${x.r}`))].sort();

        rooms.forEach(rk => {
            const [cs, rm] = rk.split('|');
            const row = document.createElement('tr');
            row.innerHTML = `<td class="col-phong">${cs}<br>${rm}</td>`;
            for(let d=2; d<=8; d++) {
                let cellM = weekM.filter(x => x.dy == d && x.cs == cs && x.r == rm).sort((a,b)=>a.t1.localeCompare(b.t1));
                let dayAll = weekM.filter(x => x.dy == d);
                let html = ""; let hasConflict = false;

                cellM.forEach(m => {
                    let isConflict = dayAll.some(o => m.id !== o.id && m.t1 < o.t2 && o.t1 < m.t2);
                    if(isConflict) hasConflict = true;
                    html += `<div class="mon-item">
                        <span class="ten-mon">${m.n}</span>
                        <span style="font-weight:bold">${m.t1}-${m.t2}</span>
                        <span class="gv-name">${m.gv}</span>
                        ${isConflict ? '<span class="trung-lich">TRÙNG LỊCH</span>' : ''}
                        ${curU === 'giangvien' ? `<button class="btn-del" onclick="del(${m.id})">Xóa</button>` : ''}
                    </div>`;
                });
                let td = document.createElement('td');
                if(hasConflict) td.className = 'bg-conflict';
                td.innerHTML = html; row.appendChild(td);
            }
            tbody.appendChild(row);
        });
    }

    function del(id) {
        if(confirm("Xóa môn?")) {
            listM = listM.filter(x => x.id !== id);
            localStorage.setItem('final_tkb_data', JSON.stringify(listM));
            render();
        }
    }

    function exportData() {
        const dataStr = JSON.stringify(listM);
        const blob = new Blob([dataStr], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = "tkb_backup.json"; a.click();
    }
</script>
</body>
</html>
