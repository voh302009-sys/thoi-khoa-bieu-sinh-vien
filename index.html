<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống TKB Sinh Viên - Đồng Bộ Toàn Thiết Bị</title>
    <style>
        :root { --red: #ff0000; --blue: #0000ff; --warning: #ffd700; --bg-conflict: #ffcccc; --dark: #2c3e50; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; background-color: #f0f2f5; text-align: center; }
        
        /* Đăng nhập */
        #login-screen { display: flex; justify-content: center; align-items: center; height: 100vh; background: var(--dark); position: fixed; width: 100%; top: 0; left: 0; z-index: 2000; }
        .auth-box { background: white; padding: 40px; border-radius: 15px; width: 90%; max-width: 380px; box-shadow: 0 15px 35px rgba(0,0,0,0.5); }
        .auth-box input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; text-align: center; font-size: 16px; }
        
        /* Giao diện chính */
        #main-app { display: none; padding: 10px; }
        .header-tools { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        
        /* Form Admin */
        .admin-panel { background: #fff; padding: 20px; border-radius: 12px; margin-bottom: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; border: 2px solid #e74c3c; }
        
        /* Bảng TKB */
        .table-container { overflow-x: auto; background: white; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th, td { border: 1px solid #dee2e6; padding: 10px; vertical-align: top; text-align: center; }
        th { background: var(--dark); color: white; font-size: 13px; }
        .col-phong { background: #f8f9fa; font-weight: bold; width: 120px; vertical-align: middle; }

        /* Môn học */
        .mon-item { border-bottom: 2px dashed #eee; padding: 12px 0; display: flex; flex-direction: column; align-items: center; gap: 3px; }
        .ten-mon { font-weight: bold; color: var(--red); text-transform: uppercase; font-size: 13px; }
        .gv-name { font-style: italic; color: var(--blue); font-size: 12px; }
        .info-txt { font-size: 11px; color: #666; }
        .time-txt { font-weight: bold; font-size: 14px; color: #333; margin: 2px 0; }
        
        /* Cảnh báo */
        .khac-co-so { background: var(--warning); color: #856404; font-style: italic; font-weight: bold; font-size: 10px; padding: 4px; border-radius: 4px; margin-bottom: 5px; border: 1px solid #e6c200; }
        .trung-lich { color: var(--red); font-style: italic; font-weight: bold; font-size: 11px; text-transform: uppercase; }
        .bg-conflict { background-color: var(--bg-conflict) !important; }

        button { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-green { background: #27ae60; color: white; }
        .btn-del { background: #e74c3c; color: white; font-size: 10px; padding: 4px 8px; margin-top: 5px; }

        @media print { .header-tools, .admin-panel, button, #login-screen { display: none !important; } #main-app { display: block !important; } }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="auth-box">
        <h2>ĐĂNG NHẬP TKB</h2>
        <input type="text" id="u-id" placeholder="Tên đăng nhập (giangvien/sv...)">
        <input type="password" id="u-pw" placeholder="Mật khẩu">
        <button class="btn-green" style="width: 100%;" onclick="doLogin()">XEM LỊCH HỌC</button>
    </div>
</div>

<div id="main-app">
    <div class="header-tools">
        <strong>Chào:</strong> <span id="user-tag"></span> | 
        <strong>Tuần có ngày:</strong> <input type="date" id="week-picker" onchange="render()">
        <button onclick="window.print()" style="background:#3498db; color:white;">IN LỊCH</button>
        <button onclick="location.reload()" style="background:#95a5a6; color:white;">ĐĂNG XUẤT</button>
    </div>

    <div id="gv-form" class="admin-panel" style="display: none;">
        <input type="text" id="f-n" placeholder="Tên môn học">
        <select id="f-t"><option>LÍ THUYẾT</option><option>THỰC HÀNH</option></select>
        <input type="number" id="f-tc" placeholder="Tín chỉ">
        <input type="text" id="f-c" placeholder="Mã HP">
        <input type="text" id="f-gv" placeholder="Giảng viên">
        <select id="f-cs"><option>ADV</option><option>LVS</option><option>LLQ</option></select>
        <input type="text" id="f-r" placeholder="Phòng">
        <select id="f-d">
            <option value="2">Thứ 2</option><option value="3">Thứ 3</option><option value="4">Thứ 4</option>
            <option value="5">Thứ 5</option><option value="6">Thứ 6</option><option value="7">Thứ 7</option><option value="8">CN</option>
        </select>
        <input type="time" id="f-t1" value="06:30"> <input type="time" id="f-t2" value="09:00">
        <input type="date" id="f-d1"> <input type="date" id="f-d2">
        <button class="btn-green" style="grid-column: 1/-1" onclick="addM()">THÊM MÔN VÀO HỆ THỐNG CHUNG</button>
        <button onclick="exportData()" style="background:#e67e22; color:white; grid-column: 1/-1">XUẤT DỮ LIỆU ĐỂ CẬP NHẬT CODE</button>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Phòng</th><th>Thứ 2</th><th>Thứ 3</th><th>Thứ 4</th><th>Thứ 5</th><th>Thứ 6</th><th>Thứ 7</th><th>CN</th>
                </tr>
            </thead>
            <tbody id="tkb-body"></tbody>
        </table>
    </div>
</div>

<script>
    /* ============================================================
       HƯỚNG DẪN: Dán đoạn mã JSON bạn đã copy vào trong cặp ngoặc []
       ============================================================ */
    const DATA_GOC = [{"id":1766166183390,"n":"LỊCH SỬ ĐẢNG CỘNG SẢN VIỆT NAM","tp":"LÍ THUYẾT","tc":"2","cd":"POLI2004","gv":"Phạm Mạnh Thắng","cs":"ADV","r":"A.103","dy":"3","t1":"09:10","t2":"11:40","d1":"2026-01-20","d2":"2026-02-06"},{"id":1766166190685,"n":"LỊCH SỬ ĐẢNG CỘNG SẢN VIỆT NAM","tp":"LÍ THUYẾT","tc":"2","cd":"POLI2004","gv":"Phạm Mạnh Thắng","cs":"ADV","r":"A.103","dy":"6","t1":"09:10","t2":"11:40","d1":"2026-01-20","d2":"2026-02-06"},{"id":1766166367816,"n":"CƠ SỞ DI TRUYỀN HỌC","tp":"THỰC HÀNH","tc":"5","cd":"ABIO1808","gv":"Đỗ Thành Trí","cs":"ADV","r":"M.105","dy":"4","t1":"12:30","t2":"15:00","d1":"2026-03-25","d2":"2026-04-22"},{"id":1766166543917,"n":"CƠ SỞ DI TRUYỀN HỌC","tp":"LÍ THUYẾT","tc":"5","cd":"ABIO1808","gv":"Đỗ Thành Trí","cs":"LVS","r":"B.101","dy":"5","t1":"06:30","t2":"09:00","d1":"2026-01-22","d2":"2026-04-02"},{"id":1766166556643,"n":"CƠ SỞ DI TRUYỀN HỌC","tp":"LÍ THUYẾT","tc":"5","cd":"ABIO1808","gv":"Đỗ Thành Trí","cs":"LVS","r":"B.101","dy":"6","t1":"06:30","t2":"09:00","d1":"2026-01-22","d2":"2026-04-02"},{"id":1766166603939,"n":"PHƯƠNG PHÁP NGHIÊN CỨU KHOA HỌC","tp":"LÍ THUYẾT","tc":"2","cd":"PSYC2804","gv":"Nguyễn Thị Thương Huyền","cs":"LVS","r":"B.101","dy":"5","t1":"09:10","t2":"11:40","d1":"2026-01-22","d2":"2026-04-16"},{"id":1766166715910,"n":"AN TOÀN SINH HỌC","tp":"LÍ THUYẾT","tc":"2","cd":"ABIO1802","gv":"Nguyễn Ngọc Phương, Trần Thị Minh Định","cs":"LVS","r":"B.101","dy":"5","t1":"12:30","t2":"15:00","d1":"2026-03-12","d2":"2026-04-09"},{"id":1766166831220,"n":"SINH LÍ HỌC VẬT NUÔI","tp":"THỰC HÀNH","tc":"4","cd":"ABIO1810","gv":"Nguyễn Thị Thương Huyền","cs":"ADV","r":"M.103","dy":"6","t1":"06:30","t2":"11:40","d1":"2026-04-03","d2":"2026-05-08"},{"id":1766168424475,"n":"SINH LÍ HỌC VẬT NUÔI","tp":"LÍ THUYẾT","tc":"2","cd":"ABIO1810","gv":"Nguyễn Thị Thương Huyền","cs":"LVS","r":"B","dy":4,"t1":"12:30","t2":"15:00","d1":"2026-01-21","d2":"2026-04-15"}]; 

    // QUAN TRỌNG: Ưu tiên dữ liệu từ DATA_GOC để SV thấy lịch ngay
    let listM = (DATA_GOC.length > 0) ? DATA_GOC : (JSON.parse(localStorage.getItem('final_tkb_data')) || []);

    let curU = "";
    document.getElementById('week-picker').valueAsDate = new Date();

    function doLogin() {
        const u = document.getElementById('u-id').value.trim().toLowerCase();
        const p = document.getElementById('u-pw').value;
        if ((u === 'giangvien' && p === 'gv123') || (u.startsWith('sv') && p === 'sv123') || (u === 'sinhvien' && p === 'sv123')) {
            curU = u;
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            document.getElementById('user-tag').innerText = u;
            if(u === 'giangvien') document.getElementById('gv-form').style.display = 'grid';
            render();
        } else alert("Sai tài khoản hoặc mật khẩu!");
    }

    function addM() {
        const m = {
            id: Date.now(), n: document.getElementById('f-n').value.toUpperCase(),
            tp: document.getElementById('f-t').value, tc: document.getElementById('f-tc').value,
            cd: document.getElementById('f-c').value, gv: document.getElementById('f-gv').value,
            cs: document.getElementById('f-cs').value, r: document.getElementById('f-r').value.toUpperCase(),
            dy: parseInt(document.getElementById('f-d').value), t1: document.getElementById('f-t1').value,
            t2: document.getElementById('f-t2').value, d1: document.getElementById('f-d1').value, d2: document.getElementById('f-d2').value
        };
        listM.push(m);
        localStorage.setItem('final_tkb_data', JSON.stringify(listM));
        render();
    }

    function render() {
        const tbody = document.getElementById('tkb-body');
        tbody.innerHTML = "";
        const selDate = new Date(document.getElementById('week-picker').value);
        const day = selDate.getDay();
        const mon = new Date(selDate.setDate(selDate.getDate() - (day === 0 ? 6 : day - 1))); mon.setHours(0,0,0,0);
        const sun = new Date(mon); sun.setDate(mon.getDate() + 6); sun.setHours(23,59,59,999);

        let weekM = listM.filter(m => {
            let s = new Date(m.d1); let e = new Date(m.d2);
            return s <= sun && e >= mon;
        });

        let rooms = [...new Set(weekM.map(x => `${x.cs}|${x.r}`))].sort();

        rooms.forEach(rk => {
            const [cs, rm] = rk.split('|');
            const row = document.createElement('tr');
            row.innerHTML = `<td class="col-phong">${cs}<br>${rm}</td>`;
            for(let d=2; d<=8; d++) {
                let cellM = weekM.filter(x => x.dy == d && x.cs == cs && x.r == rm).sort((a,b)=>a.t1.localeCompare(b.t1));
                let dayAll = weekM.filter(x => x.dy == d);
                let html = ""; let hasConflict = false;

                if(new Set(dayAll.map(x => x.cs)).size > 1 && cellM.length > 0) 
                    html += `<div class="khac-co-so">⚠ Khác cơ sở trong buổi học</div>`;

                cellM.forEach(m => {
                    let isConflict = dayAll.some(o => m.id !== o.id && m.t1 < o.t2 && o.t1 < m.t2);
                    if(isConflict) hasConflict = true;
                    html += `<div class="mon-item">
                        <span class="ten-mon">${m.n} (${m.tp})</span>
                        <span class="info-txt">Mã: ${m.cd} - ${m.tc} TC</span>
                        <span class="time-txt">${m.t1} - ${m.t2}</span>
                        <span class="gv-name">GV: ${m.gv}</span>
                        <span class="info-txt">${m.cs}, ${m.r}</span>
                        <span class="info-txt">${m.d1.split('-').reverse().join('/')} - ${m.d2.split('-').reverse().join('/')}</span>
                        ${isConflict ? '<span class="trung-lich">trùng lịch</span>' : ''}
                        ${curU === 'giangvien' ? `<button class="btn-del" onclick="del(${m.id})">Xóa</button>` : ''}
                    </div>`;
                });
                let td = document.createElement('td');
                if(hasConflict) td.className = 'bg-conflict';
                td.innerHTML = html; row.appendChild(td);
            }
            tbody.appendChild(row);
        });
    }

    function del(id) {
        if(confirm("Xóa môn?")) {
            listM = listM.filter(x => x.id !== id);
            localStorage.setItem('final_tkb_data', JSON.stringify(listM));
            render();
        }
    }

    function exportData() {
        prompt("Copy đoạn mã này và dán vào biến DATA_GOC trong code:", JSON.stringify(listM));
    }
</script>
</body>
</html>
